<%- include('partials/head', { pageClass: 'page-product' }) %>

<!-- ================================ -->
<!-- PRODUCT DETAIL PAGE              -->
<!-- RacketBazaar - Mobile-First      -->
<!-- Simplified: Media + Description  -->
<!-- + Store Link + WhatsApp Order    -->
<!-- ================================ -->

<style>
    /* Horizontal scrollable media gallery */
    .media-gallery {
        display: flex;
        gap: 4px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scrollbar-width: none;
        -ms-overflow-style: none;
        -webkit-overflow-scrolling: touch;
    }
    
    .media-gallery::-webkit-scrollbar {
        display: none;
    }
    
    .media-gallery-item {
        flex-shrink: 0;
        width: 100%;
        scroll-snap-align: start;
        aspect-ratio: 1;
        background: #f7f8f3;
    }
    
    .media-gallery-item img,
    .media-gallery-item video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    /* Gallery dots indicator */
    .gallery-dots {
        display: flex;
        justify-content: center;
        gap: 6px;
        padding: 12px 0;
    }
    
    .gallery-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #d4d8c9;
        transition: all 0.3s ease;
    }
    
    .gallery-dot.active {
        background: #556B2F;
        width: 24px;
        border-radius: 4px;
    }
    
    /* Video play indicator overlay */
    .video-play-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.2);
        pointer-events: none;
        transition: opacity 0.3s;
    }
    
    .video-play-overlay.hidden {
        opacity: 0;
    }
</style>

<div class="min-h-screen bg-olive-50 font-sans">

    <!-- ========== STICKY HEADER ========== -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-olive-100">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Left: Back Button -->
            <a href="javascript:history.back()" class="p-2 -ml-2 rounded-lg hover:bg-olive-100 active:bg-olive-200 transition-colors" aria-label="Go back">
                <i data-lucide="arrow-left" class="w-6 h-6 text-olive-950"></i>
            </a>
            
            <!-- Center: Logo -->
            <a href="/" class="flex items-center gap-1">
                <span class="text-xl font-bold text-olive-700 tracking-tight">Racket</span>
                <span class="text-xl font-bold text-olive-950">Bazaar</span>
            </a>
            
            <!-- Right: Icons -->
            <div class="flex items-center gap-1">
                <button class="p-2 rounded-lg hover:bg-olive-100 active:bg-olive-200 transition-colors" aria-label="Share" id="share-btn">
                    <i data-lucide="share-2" class="w-5 h-5 text-olive-950"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ========== BREADCRUMBS ========== -->
    <nav class="px-4 py-3 bg-white border-b border-olive-100">
        <ol class="flex items-center gap-2 text-sm text-olive-500 overflow-x-auto whitespace-nowrap">
            <li><a href="/" class="hover:text-olive-700 transition-colors">Home</a></li>
            <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
            <li><a href="/products" class="hover:text-olive-700 transition-colors">Products</a></li>
            <% if (product.category) { %>
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li><a href="/products?category=<%= product.category %>" class="hover:text-olive-700 transition-colors capitalize"><%= product.category %></a></li>
            <% } %>
            <% if (product.name) { %>
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li class="text-olive-900 font-medium truncate max-w-[150px]"><%= product.name %></li>
            <% } %>
        </ol>
    </nav>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="pb-24">
        
        <!-- Media Gallery Section -->
        <section class="bg-white">
            <% 
            // Combine all media
            const allMedia = [];
            if (product.images && product.images.length > 0) {
                product.images.forEach(img => {
                    allMedia.push({ type: 'image', url: img });
                });
            }
            if (product.video && product.video.url) {
                allMedia.push({ type: 'video', url: product.video.url });
            }
            const totalMedia = allMedia.length;
            %>
            
            <% if (totalMedia === 0) { %>
                <!-- No media placeholder -->
                <div class="aspect-square bg-olive-100 flex items-center justify-center">
                    <div class="text-center">
                        <i data-lucide="image-off" class="w-20 h-20 text-olive-300 mx-auto mb-2"></i>
                        <p class="text-olive-400 text-sm">No images available</p>
                    </div>
                </div>
            <% } else if (totalMedia === 1) { %>
                <!-- Single media -->
                <div class="aspect-square bg-olive-50">
                    <% if (allMedia[0].type === 'video') { %>
                        <video src="<%= allMedia[0].url %>" controls playsinline class="w-full h-full object-contain"></video>
                    <% } else { %>
                        <img src="<%= allMedia[0].url %>" alt="<%= product.name || 'Product' %>" class="w-full h-full object-contain">
                    <% } %>
                </div>
            <% } else { %>
                <!-- Multiple media - horizontal scroll gallery -->
                <div class="relative">
                    <div class="media-gallery" id="media-gallery">
                        <% allMedia.forEach((media, index) => { %>
                            <div class="media-gallery-item relative" data-index="<%= index %>">
                                <% if (media.type === 'video') { %>
                                    <video 
                                        src="<%= media.url %>" 
                                        controls 
                                        playsinline 
                                        class="w-full h-full object-contain"
                                        id="video-<%= index %>"
                                    ></video>
                                <% } else { %>
                                    <img 
                                        src="<%= media.url %>" 
                                        alt="<%= product.name || 'Product' %> - Image <%= index + 1 %>" 
                                        class="w-full h-full object-contain"
                                        loading="<%= index === 0 ? 'eager' : 'lazy' %>"
                                    >
                                <% } %>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- Counter badge -->
                    <div class="absolute bottom-4 right-4 px-3 py-1.5 bg-black/60 text-white text-sm rounded-full">
                        <span id="current-slide">1</span> / <%= totalMedia %>
                    </div>
                </div>
                
                <!-- Gallery dots -->
                <div class="gallery-dots" id="gallery-dots">
                    <% for (let i = 0; i < totalMedia; i++) { %>
                        <div class="gallery-dot <%= i === 0 ? 'active' : '' %>" data-index="<%= i %>"></div>
                    <% } %>
                </div>
            <% } %>
        </section>
        
        <!-- Product Info Section -->
        <section class="px-4 py-6 bg-white border-t border-olive-100">
            
            <!-- Brand & Category -->
            <% if (product.brand || product.category) { %>
                <div class="flex items-center gap-2 mb-2">
                    <% if (product.brand) { %>
                        <span class="text-sm font-medium text-olive-600 uppercase tracking-wide"><%= product.brand %></span>
                        <% if (product.category) { %>
                            <span class="text-olive-300">•</span>
                        <% } %>
                    <% } %>
                    <% if (product.category) { %>
                        <a href="/products?category=<%= product.category %>" class="text-sm text-olive-500 capitalize hover:text-olive-700 transition-colors">
                            <%= product.category %>
                        </a>
                    <% } %>
                </div>
            <% } %>
            
            <!-- Product Name -->
            <% if (product.name) { %>
                <h1 class="text-2xl font-bold text-olive-950 leading-tight mb-3"><%= product.name %></h1>
            <% } %>
            
            <!-- Price -->
            <% if (product.price) { %>
                <div class="flex items-baseline gap-3 mb-4">
                    <span class="text-3xl font-bold text-olive-900">Rs. <%= product.price.toLocaleString() %></span>
                </div>
            <% } %>
            
            <!-- Condition Badge -->
            <% if (product.condition) { %>
                <div class="flex items-center gap-2 mb-4">
                    <% if (product.condition === 'used') { %>
                        <span class="inline-flex items-center px-3 py-1.5 bg-amber-100 text-amber-700 text-sm font-medium rounded-lg">
                            Pre-owned
                            <% if (product.conditionRating) { %>
                                • <%= product.conditionRating %>/10
                            <% } %>
                        </span>
                    <% } else { %>
                        <span class="inline-flex items-center px-3 py-1.5 bg-emerald-100 text-emerald-700 text-sm font-medium rounded-lg">
                            Brand New
                        </span>
                    <% } %>
                </div>
            <% } %>
            
            <!-- Description -->
            <% if (product.description) { %>
                <div class="mb-6">
                    <h2 class="text-sm font-semibold text-olive-900 mb-2">Description</h2>
                    <p class="text-olive-600 leading-relaxed whitespace-pre-line"><%= product.description %></p>
                </div>
            <% } %>
            
        </section>
        
        <!-- Seller/Store Card -->
        <% if (product.sellerInfo) { %>
            <section class="px-4 py-4 bg-white border-t border-olive-100 mt-2">
                <h2 class="text-sm font-semibold text-olive-900 mb-3">Seller</h2>
                <a href="/store/<%= product.sellerInfo._id %>" class="flex items-center gap-4 p-4 bg-olive-50 rounded-2xl hover:bg-olive-100 transition-colors">
                    <div class="w-14 h-14 bg-olive-200 rounded-full flex items-center justify-center flex-shrink-0">
                        <i data-lucide="store" class="w-7 h-7 text-olive-600"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-olive-900"><%= product.sellerInfo.storeName %></p>
                        <p class="text-sm text-olive-500">View Store</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-olive-400 flex-shrink-0"></i>
                </a>
            </section>
        <% } %>
        
        <!-- Additional Info (if any specs are available) -->
        <% 
        const hasSpecs = (product.specifications && (product.specifications.weight || product.specifications.material || product.specifications.color || product.specifications.size)) ||
                         (product.racketSpecs && (product.racketSpecs.weightClass || product.racketSpecs.flexibility || product.racketSpecs.balance)) ||
                         (product.shoeSpecs && (product.shoeSpecs.sizeEU || product.shoeSpecs.sizeUS || product.shoeSpecs.width));
        %>
        <% if (hasSpecs) { %>
            <section class="px-4 py-4 bg-white border-t border-olive-100 mt-2">
                <h2 class="text-sm font-semibold text-olive-900 mb-3">Specifications</h2>
                <div class="space-y-2">
                    <% if (product.specifications) { %>
                        <% if (product.specifications.weight) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Weight</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.specifications.weight %></span>
                            </div>
                        <% } %>
                        <% if (product.specifications.material) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Material</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.specifications.material %></span>
                            </div>
                        <% } %>
                        <% if (product.specifications.color) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Color</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.specifications.color %></span>
                            </div>
                        <% } %>
                        <% if (product.specifications.size) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Size</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.specifications.size %></span>
                            </div>
                        <% } %>
                    <% } %>
                    
                    <% if (product.category === 'rackets' && product.racketSpecs) { %>
                        <% if (product.racketSpecs.weightClass) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Weight Class</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.racketSpecs.weightClass %></span>
                            </div>
                        <% } %>
                        <% if (product.racketSpecs.flexibility) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Flexibility</span>
                                <span class="text-sm font-medium text-olive-900 capitalize"><%= product.racketSpecs.flexibility %></span>
                            </div>
                        <% } %>
                        <% if (product.racketSpecs.balance) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Balance</span>
                                <span class="text-sm font-medium text-olive-900 capitalize"><%= product.racketSpecs.balance %></span>
                            </div>
                        <% } %>
                        <% if (product.racketSpecs.gripSize) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Grip Size</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.racketSpecs.gripSize %></span>
                            </div>
                        <% } %>
                    <% } %>
                    
                    <% if (product.category === 'shoes' && product.shoeSpecs) { %>
                        <% if (product.shoeSpecs.sizeEU) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Size (EU)</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.shoeSpecs.sizeEU %></span>
                            </div>
                        <% } %>
                        <% if (product.shoeSpecs.sizeUS) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Size (US)</span>
                                <span class="text-sm font-medium text-olive-900"><%= product.shoeSpecs.sizeUS %></span>
                            </div>
                        <% } %>
                        <% if (product.shoeSpecs.width) { %>
                            <div class="flex justify-between py-2 border-b border-olive-50">
                                <span class="text-sm text-olive-500">Width</span>
                                <span class="text-sm font-medium text-olive-900 capitalize"><%= product.shoeSpecs.width %></span>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </section>
        <% } %>
        
    </main>

    <!-- ========== STICKY BOTTOM CTA ========== -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-olive-100 px-4 py-4 z-40">
        <% if (product.sellerInfo && product.sellerInfo.phone) { %>
            <a 
                href="https://wa.me/<%= product.sellerInfo.phone.replace(/[^0-9]/g, '') %>?text=Hi!%20I%20want%20to%20order%20<%= encodeURIComponent(product.name || 'this product') %><%= product.price ? '%20(Rs.%20' + product.price.toLocaleString() + ')' : '' %>%20from%20RacketBazaar%0A%0AProduct%20Link:%20<%= encodeURIComponent('https://racketbazaar.com/products/' + product._id) %>"
                target="_blank"
                rel="noopener"
                class="flex items-center justify-center gap-3 w-full py-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-2xl transition-colors shadow-lg text-lg"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                <span>Confirm Order on WhatsApp</span>
            </a>
        <% } else { %>
            <a 
                href="/products"
                class="flex items-center justify-center gap-2 w-full py-4 bg-olive-700 hover:bg-olive-800 text-white font-semibold rounded-2xl transition-colors text-lg"
            >
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                <span>Browse More Products</span>
            </a>
        <% } %>
    </div>

</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Media Gallery Scroll Handling
    const gallery = document.getElementById('media-gallery');
    const currentSlide = document.getElementById('current-slide');
    const dots = document.querySelectorAll('.gallery-dot');
    
    if (gallery) {
        let isScrolling = false;
        
        gallery.addEventListener('scroll', () => {
            if (!isScrolling) {
                window.requestAnimationFrame(() => {
                    const scrollLeft = gallery.scrollLeft;
                    const itemWidth = gallery.offsetWidth;
                    const activeIndex = Math.round(scrollLeft / itemWidth);
                    
                    // Update counter
                    if (currentSlide) {
                        currentSlide.textContent = activeIndex + 1;
                    }
                    
                    // Update dots
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === activeIndex);
                    });
                    
                    isScrolling = false;
                });
                isScrolling = true;
            }
        });
        
        // Click on dots to navigate
        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                const itemWidth = gallery.offsetWidth;
                gallery.scrollTo({
                    left: index * itemWidth,
                    behavior: 'smooth'
                });
            });
        });
    }
    
    // Share functionality
    document.getElementById('share-btn')?.addEventListener('click', async () => {
        const shareData = {
            title: '<%= (product.name || "Product").replace(/'/g, "\\'") %>',
            text: 'Check out this product on RacketBazaar!',
            url: window.location.href
        };
        
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                await navigator.clipboard.writeText(window.location.href);
                
                // Show toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 px-4 py-2 bg-olive-800 text-white text-sm rounded-lg shadow-lg z-50';
                toast.textContent = 'Link copied to clipboard!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }
        } catch (err) {
            console.log('Share failed:', err);
        }
    });
</script>

<%- include('partials/tail') %>
