<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | RacketBazaar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'olive': { 50: '#f7f8f5', 100: '#eef0e9', 200: '#dde1d3', 300: '#c4ccb3', 400: '#a6b18e', 500: '#8a9970', 600: '#6e7d58', 700: '#556B2F', 800: '#475a28', 900: '#3c4b24', 950: '#1f2812' },
                        'brand': { 'primary': '#556B2F', 'dark': '#1a2e1a', 'light': '#8FBC8F' },
                        'surface': { 'bg': '#FAFAF9', 'card': '#FFFFFF', 'muted': '#F5F5F4' },
                    },
                    fontFamily: { 'sans': ['Inter', 'system-ui', 'sans-serif'] },
                    boxShadow: { 'card': '0 2px 8px -2px rgba(0, 0, 0, 0.08), 0 4px 12px -4px rgba(0, 0, 0, 0.04)' },
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .nav-active { background-color: #eef0e9; color: #556B2F; border-left: 3px solid #556B2F; }
        .upload-area { border: 2px dashed #d4d4d4; transition: all 0.2s; }
        .upload-area:hover, .upload-area.dragover { border-color: #556B2F; background-color: #f7f8f5; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #556B2F !important; box-shadow: 0 0 0 3px rgba(85, 107, 47, 0.1) !important; }
        .media-preview { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        @media (max-width: 640px) { .media-preview { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body class="bg-surface-bg font-sans min-h-screen">
    
    <!-- Mobile Header -->
    <header class="lg:hidden sticky top-0 z-40 bg-white border-b border-stone-200">
        <div class="flex items-center justify-between px-4 py-3">
            <a href="/seller/products" class="p-2 -ml-2 rounded-lg hover:bg-stone-100">
                <i data-lucide="arrow-left" class="w-6 h-6 text-brand-dark"></i>
            </a>
            <span class="text-lg font-bold text-olive-700"><%= title %></span>
            <div class="w-10"></div>
        </div>
    </header>

    <div class="flex">
        <!-- Desktop Sidebar -->
        <aside class="hidden lg:flex lg:flex-col lg:w-64 lg:fixed lg:inset-y-0 bg-white border-r border-stone-200">
            <div class="flex items-center gap-3 px-6 py-5 border-b border-stone-100">
                <div class="w-10 h-10 bg-olive-100 rounded-xl flex items-center justify-center">
                    <i data-lucide="store" class="w-5 h-5 text-olive-700"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-brand-dark truncate"><%= typeof storeName !== 'undefined' ? storeName : 'Seller' %></p>
                    <p class="text-xs text-stone-500">Seller Panel</p>
                </div>
            </div>
            <nav class="flex-1 px-3 py-4 space-y-1">
                <a href="/seller/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-stone-600 hover:bg-stone-50">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    Dashboard
                </a>
                <a href="/seller/products" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium nav-active">
                    <i data-lucide="package" class="w-5 h-5"></i>
                    Products
                </a>
                <a href="/seller/orders" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-stone-600 hover:bg-stone-50">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    Orders
                </a>
            </nav>
            <div class="px-3 py-4 border-t border-stone-100 space-y-1">
                <a href="/" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-stone-600 hover:bg-stone-50">
                    <i data-lucide="external-link" class="w-5 h-5"></i>
                    View Store
                </a>
                <a href="/seller/logout" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 min-h-screen pb-24 lg:pb-8">
            <div class="p-4 lg:p-6 max-w-2xl mx-auto">
                
                <!-- Desktop Header -->
                <div class="hidden lg:flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <a href="/seller/products" class="p-2 rounded-lg hover:bg-stone-100">
                            <i data-lucide="arrow-left" class="w-5 h-5 text-stone-500"></i>
                        </a>
                        <div>
                            <h1 class="text-2xl font-bold text-brand-dark"><%= title %></h1>
                            <p class="text-stone-500 mt-1"><%= product ? 'Update your product' : 'Upload photos and add a description' %></p>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <% if (error) { %>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4 flex items-start gap-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-sm text-red-700"><%= error %></p>
                </div>
                <% } %>

                <form action="<%= action %>" method="POST" enctype="multipart/form-data" id="productForm">
                    
                    <!-- Media Upload Section -->
                    <div class="bg-white rounded-2xl shadow-card p-5 mb-4">
                        <h2 class="font-semibold text-brand-dark mb-1">Photos & Video</h2>
                        <p class="text-sm text-stone-500 mb-4">Upload up to 7 photos and 1 video of your product</p>
                        
                        <!-- Photo Upload -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-stone-700 mb-2">
                                Photos <span class="text-red-500">*</span>
                                <span class="text-stone-400 font-normal">(max 7)</span>
                            </label>
                            
                            <div id="photoUploadArea" class="upload-area rounded-xl p-6 text-center cursor-pointer">
                                <input type="file" id="photoInput" name="images" multiple accept="image/jpeg,image/png,image/webp" class="hidden">
                                <i data-lucide="image-plus" class="w-10 h-10 text-stone-400 mx-auto mb-2"></i>
                                <p class="text-sm font-medium text-stone-600">Tap to upload photos</p>
                                <p class="text-xs text-stone-400 mt-1">JPG, PNG, WebP • Max 5MB each</p>
                            </div>
                            
                            <!-- Photo Preview Grid -->
                            <div id="photoPreview" class="media-preview mt-3 hidden"></div>
                            <p id="photoCount" class="text-xs text-stone-500 mt-2 hidden">0/7 photos selected</p>
                        </div>
                        
                        <!-- Video Upload -->
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">
                                Video
                                <span class="text-stone-400 font-normal">(optional, max 1)</span>
                            </label>
                            
                            <div id="videoUploadArea" class="upload-area rounded-xl p-6 text-center cursor-pointer">
                                <input type="file" id="videoInput" name="video" accept="video/mp4,video/mov,video/webm" class="hidden">
                                <i data-lucide="video" class="w-10 h-10 text-stone-400 mx-auto mb-2"></i>
                                <p class="text-sm font-medium text-stone-600">Tap to upload video</p>
                                <p class="text-xs text-stone-400 mt-1">MP4, MOV, WebM • Max 50MB</p>
                            </div>
                            
                            <!-- Video Preview -->
                            <div id="videoPreview" class="mt-3 hidden">
                                <div class="relative inline-block">
                                    <video id="previewVideo" class="w-40 h-28 object-cover rounded-xl border-2 border-olive-500" muted></video>
                                    <button type="button" onclick="clearVideo()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm hover:bg-red-600">×</button>
                                    <div class="absolute bottom-1 left-1 bg-black/60 text-white text-xs px-2 py-0.5 rounded">
                                        <i data-lucide="video" class="w-3 h-3 inline"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <% if (product && product.images && product.images.length > 0) { %>
                        <!-- Existing Images for Edit Mode -->
                        <div class="mt-4 pt-4 border-t border-stone-200">
                            <label class="block text-sm font-medium text-stone-700 mb-2">Current Photos</label>
                            <div class="media-preview">
                                <% product.images.forEach((img, index) => { %>
                                <div class="relative aspect-square rounded-xl overflow-hidden bg-stone-100 border-2 border-olive-500" id="existing-img-<%= index %>">
                                    <img src="<%= img %>" class="w-full h-full object-cover">
                                    <input type="hidden" name="existingImages" value="<%= img %>">
                                    <button type="button" onclick="removeExistingImage(<%= index %>)" class="absolute top-1 right-1 w-6 h-6 bg-black/60 text-white rounded-full flex items-center justify-center text-sm hover:bg-red-500">×</button>
                                </div>
                                <% }) %>
                            </div>
                        </div>
                        <% } %>

                        <% if (product && product.video && product.video.url) { %>
                        <!-- Existing Video for Edit Mode -->
                        <div class="mt-4 pt-4 border-t border-stone-200">
                            <label class="block text-sm font-medium text-stone-700 mb-2">Current Video</label>
                            <div class="relative inline-block" id="existing-video">
                                <video src="<%= product.video.url %>" class="w-40 h-28 object-cover rounded-xl border-2 border-olive-500" muted></video>
                                <button type="button" onclick="removeExistingVideo()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm hover:bg-red-600">×</button>
                            </div>
                            <input type="hidden" name="removeVideo" id="removeVideoFlag" value="false">
                        </div>
                        <% } %>
                    </div>
                    
                    <!-- Description Section -->
                    <div class="bg-white rounded-2xl shadow-card p-5 mb-4">
                        <h2 class="font-semibold text-brand-dark mb-1">Product Description</h2>
                        <p class="text-sm text-stone-500 mb-4">Describe your product in detail</p>
                        
                        <textarea 
                            name="description" 
                            id="description"
                            rows="6" 
                            required
                            placeholder="Describe your product... Include details like brand, condition, size, color, specifications, and any other relevant information that buyers would want to know."
                            class="w-full px-4 py-3 border border-stone-200 rounded-xl text-sm resize-none"
                        ><%= product ? product.description : '' %></textarea>
                        <p class="text-xs text-stone-400 mt-2">Be detailed - good descriptions help your product sell faster!</p>
                    </div>
                    
                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn" class="w-full py-4 bg-olive-700 text-white font-semibold rounded-xl hover:bg-olive-800 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="<%= product ? 'save' : 'plus-circle' %>" class="w-5 h-5"></i>
                        <span><%= product ? 'Update Product' : 'Create Product' %></span>
                    </button>
                    
                </form>
                
            </div>
        </main>
    </div>

    <script>
        lucide.createIcons();
        
        // Photo upload handling
        const photoUploadArea = document.getElementById('photoUploadArea');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const photoCount = document.getElementById('photoCount');
        let selectedPhotos = [];
        const MAX_PHOTOS = 7;
        
        photoUploadArea.addEventListener('click', () => photoInput.click());
        
        // Drag and drop for photos
        photoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUploadArea.classList.add('dragover');
        });
        photoUploadArea.addEventListener('dragleave', () => {
            photoUploadArea.classList.remove('dragover');
        });
        photoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            photoUploadArea.classList.remove('dragover');
            handlePhotoFiles(e.dataTransfer.files);
        });
        
        photoInput.addEventListener('change', (e) => {
            handlePhotoFiles(e.target.files);
        });
        
        function handlePhotoFiles(files) {
            const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            const spaceLeft = MAX_PHOTOS - selectedPhotos.length;
            const filesToAdd = newFiles.slice(0, spaceLeft);
            
            if (newFiles.length > spaceLeft) {
                alert('You can only upload ' + MAX_PHOTOS + ' photos maximum. ' + (newFiles.length - spaceLeft) + ' file(s) were not added.');
            }
            
            selectedPhotos = [...selectedPhotos, ...filesToAdd];
            renderPhotoPreview();
            updatePhotoInput();
        }
        
        function renderPhotoPreview() {
            if (selectedPhotos.length === 0) {
                photoPreview.classList.add('hidden');
                photoCount.classList.add('hidden');
                return;
            }
            
            photoPreview.classList.remove('hidden');
            photoCount.classList.remove('hidden');
            photoCount.textContent = selectedPhotos.length + '/' + MAX_PHOTOS + ' photos selected';
            
            photoPreview.innerHTML = '';
            selectedPhotos.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'relative aspect-square rounded-xl overflow-hidden bg-stone-100';
                
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.src = URL.createObjectURL(file);
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'absolute top-1 right-1 w-6 h-6 bg-black/60 text-white rounded-full flex items-center justify-center text-sm hover:bg-red-500';
                btn.innerHTML = '×';
                btn.onclick = () => removePhoto(index);
                
                if (index === 0) {
                    const badge = document.createElement('div');
                    badge.className = 'absolute bottom-1 left-1 bg-olive-700 text-white text-xs px-2 py-0.5 rounded';
                    badge.textContent = 'Main';
                    div.appendChild(badge);
                }
                
                div.appendChild(img);
                div.appendChild(btn);
                photoPreview.appendChild(div);
            });
            
            // Add "add more" button if space left
            if (selectedPhotos.length < MAX_PHOTOS) {
                const addBtn = document.createElement('div');
                addBtn.className = 'aspect-square rounded-xl border-2 border-dashed border-stone-300 flex flex-col items-center justify-center cursor-pointer hover:border-olive-500 hover:bg-stone-50';
                addBtn.innerHTML = '<svg class="w-6 h-6 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg><span class="text-xs text-stone-500 mt-1">Add more</span>';
                addBtn.onclick = () => photoInput.click();
                photoPreview.appendChild(addBtn);
            }
        }
        
        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            renderPhotoPreview();
            updatePhotoInput();
        }
        
        function updatePhotoInput() {
            const dt = new DataTransfer();
            selectedPhotos.forEach(f => dt.items.add(f));
            photoInput.files = dt.files;
        }
        
        // Video upload handling
        const videoUploadArea = document.getElementById('videoUploadArea');
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const previewVideo = document.getElementById('previewVideo');
        let selectedVideo = null;
        
        videoUploadArea.addEventListener('click', () => videoInput.click());
        
        // Drag and drop for video
        videoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoUploadArea.classList.add('dragover');
        });
        videoUploadArea.addEventListener('dragleave', () => {
            videoUploadArea.classList.remove('dragover');
        });
        videoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            videoUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video/'));
            if (files[0]) {
                handleVideoFile(files[0]);
            }
        });
        
        videoInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleVideoFile(e.target.files[0]);
            }
        });
        
        function handleVideoFile(file) {
            if (file.size > 50 * 1024 * 1024) {
                alert('Video file is too large. Maximum size is 50MB.');
                return;
            }
            selectedVideo = file;
            previewVideo.src = URL.createObjectURL(file);
            videoPreview.classList.remove('hidden');
            videoUploadArea.classList.add('hidden');
            lucide.createIcons();
        }
        
        function clearVideo() {
            selectedVideo = null;
            videoInput.value = '';
            videoPreview.classList.add('hidden');
            videoUploadArea.classList.remove('hidden');
        }
        
        // Edit mode: Remove existing image
        function removeExistingImage(index) {
            const el = document.getElementById('existing-img-' + index);
            if (el) el.remove();
        }
        
        // Edit mode: Remove existing video
        function removeExistingVideo() {
            const el = document.getElementById('existing-video');
            if (el) el.remove();
            document.getElementById('removeVideoFlag').value = 'true';
        }
        
        // Form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            <% if (!product) { %>
            // For new products, require at least one photo
            if (selectedPhotos.length === 0) {
                e.preventDefault();
                alert('Please upload at least one photo of your product.');
                return;
            }
            <% } %>
            
            const description = document.getElementById('description').value.trim();
            if (!description) {
                e.preventDefault();
                alert('Please add a description for your product.');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span><%= product ? "Updating..." : "Creating..." %></span>';
            submitBtn.disabled = true;
        });
    </script>
</body>
</html>
