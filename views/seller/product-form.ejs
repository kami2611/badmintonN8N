<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | BadmintonStore</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/seller.css">
    <style>
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }
        
        .media-upload-section {
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            color: #999;
        }
        
        .upload-text {
            color: #666;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: #999;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f5f5;
            aspect-ratio: 1;
        }
        
        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .preview-item .remove-btn:hover {
            background: #c62828;
        }
        
        .preview-item.existing {
            border: 2px solid #667eea;
        }
        
        .preview-item .existing-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: #667eea;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .file-info {
            font-size: 11px;
            color: #666;
            text-align: center;
            padding: 5px;
            background: rgba(255,255,255,0.9);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .video-preview-container {
            margin-top: 20px;
        }
        
        .video-preview {
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .video-preview video {
            width: 100%;
            display: block;
        }
        
        .video-duration-warning {
            color: #c62828;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }
        
        .video-duration-warning.show {
            display: block;
        }
        
        .upload-limits {
            background: #e3f2fd;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #1565c0;
        }
        
        .upload-limits ul {
            margin: 5px 0 0 20px;
            list-style: disc;
        }
        
        .image-counter {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .image-counter.limit-reached {
            color: #c62828;
        }
    </style>
</head>
<body>
    <%- include('partials/sidebar') %>
    
    <main class="admin-main">
        <header class="admin-header">
            <h1><%= title %></h1>
            <a href="/seller/products" class="btn btn-outline">← Back to Products</a>
        </header>
        
        <% if (error) { %>
            <div class="error-message"><%= error %></div>
        <% } %>
        
        <form action="<%= action %>" method="POST" enctype="multipart/form-data" class="admin-form" id="productForm">
            <div class="form-section">
                <h3>Basic Information</h3>
                
                <div class="form-group">
                    <label for="name">Product Name *</label>
                    <input type="text" id="name" name="name" value="<%= product ? product.name : '' %>" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" rows="4" required><%= product ? product.description : '' %></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="price">Price ($) *</label>
                        <input type="number" id="price" name="price" step="0.01" min="0" value="<%= product ? product.price : '' %>" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="stock">Stock *</label>
                        <input type="number" id="stock" name="stock" min="0" value="<%= product ? product.stock : 0 %>" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="rackets" <%= product && product.category === 'rackets' ? 'selected' : '' %>>Rackets</option>
                            <option value="shoes" <%= product && product.category === 'shoes' ? 'selected' : '' %>>Shoes</option>
                            <option value="accessories" <%= product && product.category === 'accessories' ? 'selected' : '' %>>Accessories</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="brand">Brand *</label>
                        <input type="text" id="brand" name="brand" value="<%= product ? product.brand : '' %>" required>
                    </div>
                </div>
            </div>
            
            <div class="form-section media-upload-section">
                <h3>Product Images</h3>
                
                <div class="upload-limits">
                    <strong>Image Requirements:</strong>
                    <ul>
                        <li>Maximum 5 images per product</li>
                        <li>Maximum 2MB per image</li>
                        <li>Supported formats: JPG, PNG, WebP</li>
                    </ul>
                </div>
                
                <!-- Existing Images -->
                <% if (product && product.images && product.images.length > 0) { %>
                    <div class="preview-grid" id="existingImagesGrid">
                        <% product.images.forEach((img, index) => { %>
                            <div class="preview-item existing" data-url="<%= img %>">
                                <img src="<%= img %>" alt="Product image <%= index + 1 %>">
                                <input type="hidden" name="existingImages" value="<%= img %>">
                                <button type="button" class="remove-btn" onclick="removeExistingImage(this)">×</button>
                                <span class="existing-badge">Existing</span>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
                
                <div class="upload-area" id="imageUploadArea">
                    <input type="file" id="imageInput" name="images" multiple accept="image/jpeg,image/png,image/webp">
                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <p class="upload-text">Click or drag images here to upload</p>
                    <p class="upload-hint">JPG, PNG, WebP • Max 2MB each • Max 5 images</p>
                </div>
                
                <div class="preview-grid" id="newImagesPreview"></div>
                <p class="image-counter" id="imageCounter">0/5 images</p>
            </div>
            
            <div class="form-section media-upload-section">
                <h3>Product Video (Optional)</h3>
                
                <div class="upload-limits">
                    <strong>Video Requirements:</strong>
                    <ul>
                        <li>Maximum 1 video per product</li>
                        <li>Maximum 20 seconds duration</li>
                        <li>Supported formats: MP4, MOV, WebM</li>
                    </ul>
                </div>
                
                <!-- Existing Video -->
                <% if (product && product.video && product.video.url) { %>
                    <div class="video-preview-container" id="existingVideoContainer">
                        <div class="video-preview">
                            <video src="<%= product.video.url %>" controls></video>
                            <button type="button" class="remove-btn" onclick="removeExistingVideo()">×</button>
                        </div>
                        <p style="font-size: 13px; color: #666; margin-top: 10px;">Current video - upload a new one to replace</p>
                    </div>
                    <input type="hidden" name="removeVideo" id="removeVideoInput" value="false">
                <% } %>
                
                <div class="upload-area" id="videoUploadArea">
                    <input type="file" id="videoInput" name="video" accept="video/mp4,video/quicktime,video/webm">
                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                    <p class="upload-text">Click or drag video here to upload</p>
                    <p class="upload-hint">MP4, MOV, WebM • Max 20 seconds</p>
                </div>
                
                <div class="video-preview-container" id="newVideoPreview" style="display: none;">
                    <div class="video-preview">
                        <video id="videoPreviewElement" controls></video>
                        <button type="button" class="remove-btn" onclick="removeNewVideo()">×</button>
                    </div>
                    <p class="video-duration-warning" id="videoDurationWarning">
                        ⚠️ Video exceeds 20 seconds. Please select a shorter video.
                    </p>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Specifications</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="weight">Weight</label>
                        <input type="text" id="weight" name="weight" value="<%= product && product.specifications ? product.specifications.weight || '' : '' %>" placeholder="e.g., 83g">
                    </div>
                    
                    <div class="form-group">
                        <label for="material">Material</label>
                        <input type="text" id="material" name="material" value="<%= product && product.specifications ? product.specifications.material || '' : '' %>" placeholder="e.g., Carbon Fiber">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="color">Color</label>
                        <input type="text" id="color" name="color" value="<%= product && product.specifications ? product.specifications.color || '' : '' %>" placeholder="e.g., Black/Red">
                    </div>
                    
                    <div class="form-group">
                        <label for="size">Size</label>
                        <input type="text" id="size" name="size" value="<%= product && product.specifications ? product.specifications.size || '' : '' %>" placeholder="e.g., G4">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                    <%= product ? 'Update Product' : 'Add Product' %>
                </button>
                <a href="/seller/products" class="btn btn-outline btn-large">Cancel</a>
            </div>
        </form>
    </main>
    
    <script>
        // Track files and counts
        let newImageFiles = [];
        const existingImageCount = () => document.querySelectorAll('#existingImagesGrid .preview-item').length;
        const MAX_IMAGES = 5;
        const MAX_IMAGE_SIZE = 2 * 1024 * 1024; // 2MB
        const MAX_VIDEO_DURATION = 20; // seconds
        
        // Update image counter
        function updateImageCounter() {
            const total = existingImageCount() + newImageFiles.length;
            const counter = document.getElementById('imageCounter');
            counter.textContent = `${total}/5 images`;
            counter.classList.toggle('limit-reached', total >= MAX_IMAGES);
            
            // Disable upload area if limit reached
            const uploadArea = document.getElementById('imageUploadArea');
            if (total >= MAX_IMAGES) {
                uploadArea.style.opacity = '0.5';
                uploadArea.style.pointerEvents = 'none';
            } else {
                uploadArea.style.opacity = '1';
                uploadArea.style.pointerEvents = 'auto';
            }
        }
        
        // Image upload handling
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageInput = document.getElementById('imageInput');
        const newImagesPreview = document.getElementById('newImagesPreview');
        
        imageUploadArea.addEventListener('click', () => {
            if (existingImageCount() + newImageFiles.length < MAX_IMAGES) {
                imageInput.click();
            }
        });
        
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });
        
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });
        
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            handleImageFiles(e.dataTransfer.files);
        });
        
        imageInput.addEventListener('change', (e) => {
            handleImageFiles(e.target.files);
        });
        
        function handleImageFiles(files) {
            const currentTotal = existingImageCount() + newImageFiles.length;
            const remainingSlots = MAX_IMAGES - currentTotal;
            
            Array.from(files).slice(0, remainingSlots).forEach(file => {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name} is not an image file`);
                    return;
                }
                
                // Validate file size
                if (file.size > MAX_IMAGE_SIZE) {
                    alert(`${file.name} exceeds 2MB limit`);
                    return;
                }
                
                newImageFiles.push(file);
                
                // Create preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.dataset.index = newImageFiles.length - 1;
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-btn" onclick="removeNewImage(${newImageFiles.length - 1})">×</button>
                        <span class="file-info">${(file.size / 1024 / 1024).toFixed(2)}MB</span>
                    `;
                    newImagesPreview.appendChild(div);
                    updateImageCounter();
                };
                reader.readAsDataURL(file);
            });
            
            updateFileInput();
        }
        
        function removeNewImage(index) {
            newImageFiles.splice(index, 1);
            renderNewImagePreviews();
            updateFileInput();
            updateImageCounter();
        }
        
        function removeExistingImage(btn) {
            btn.closest('.preview-item').remove();
            updateImageCounter();
        }
        
        function renderNewImagePreviews() {
            newImagesPreview.innerHTML = '';
            newImageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-btn" onclick="removeNewImage(${index})">×</button>
                        <span class="file-info">${(file.size / 1024 / 1024).toFixed(2)}MB</span>
                    `;
                    newImagesPreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function updateFileInput() {
            // Create a new DataTransfer to update the file input
            const dt = new DataTransfer();
            newImageFiles.forEach(file => dt.items.add(file));
            imageInput.files = dt.files;
        }
        
        // Video upload handling
        const videoUploadArea = document.getElementById('videoUploadArea');
        const videoInput = document.getElementById('videoInput');
        const newVideoPreview = document.getElementById('newVideoPreview');
        const videoPreviewElement = document.getElementById('videoPreviewElement');
        const videoDurationWarning = document.getElementById('videoDurationWarning');
        let videoFile = null;
        let videoValid = true;
        
        videoUploadArea.addEventListener('click', () => videoInput.click());
        
        videoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoUploadArea.classList.add('dragover');
        });
        
        videoUploadArea.addEventListener('dragleave', () => {
            videoUploadArea.classList.remove('dragover');
        });
        
        videoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            videoUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files[0]) {
                handleVideoFile(e.dataTransfer.files[0]);
            }
        });
        
        videoInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleVideoFile(e.target.files[0]);
            }
        });
        
        function handleVideoFile(file) {
            if (!file.type.startsWith('video/')) {
                alert('Please select a video file');
                return;
            }
            
            videoFile = file;
            
            // Create object URL for preview
            const url = URL.createObjectURL(file);
            videoPreviewElement.src = url;
            newVideoPreview.style.display = 'block';
            
            // Check duration when metadata loads
            videoPreviewElement.onloadedmetadata = () => {
                const duration = videoPreviewElement.duration;
                if (duration > MAX_VIDEO_DURATION) {
                    videoDurationWarning.classList.add('show');
                    videoValid = false;
                } else {
                    videoDurationWarning.classList.remove('show');
                    videoValid = true;
                }
            };
            
            // Update file input
            const dt = new DataTransfer();
            dt.items.add(file);
            videoInput.files = dt.files;
            
            // Hide existing video if present
            const existingVideo = document.getElementById('existingVideoContainer');
            if (existingVideo) {
                existingVideo.style.display = 'none';
            }
        }
        
        function removeNewVideo() {
            videoFile = null;
            videoValid = true;
            newVideoPreview.style.display = 'none';
            videoInput.value = '';
            videoDurationWarning.classList.remove('show');
            
            // Show existing video if present
            const existingVideo = document.getElementById('existingVideoContainer');
            if (existingVideo) {
                existingVideo.style.display = 'block';
            }
        }
        
        function removeExistingVideo() {
            const existingVideo = document.getElementById('existingVideoContainer');
            if (existingVideo) {
                existingVideo.style.display = 'none';
            }
            document.getElementById('removeVideoInput').value = 'true';
        }
        
        // Form submission validation
        document.getElementById('productForm').addEventListener('submit', (e) => {
            if (!videoValid) {
                e.preventDefault();
                alert('Please select a video that is 20 seconds or shorter');
                return false;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;
        });
        
        // Initialize counter
        updateImageCounter();
    </script>
</body>
</html>
