<%- include('partials/head', { pageClass: 'page-checkout' }) %>

<!-- ================================ -->
<!-- CHECKOUT PAGE                    -->
<!-- RacketBazaar - Mobile-First      -->
<!-- ================================ -->

<div class="min-h-screen bg-olive-50 font-sans">

    <!-- ========== STICKY HEADER ========== -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-olive-100">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Left: Back to Cart -->
            <a href="/cart" class="p-2 -ml-2 rounded-lg hover:bg-olive-100 active:bg-olive-200 transition-colors" aria-label="Back to cart">
                <i data-lucide="arrow-left" class="w-6 h-6 text-olive-950"></i>
            </a>
            
            <!-- Center: Title -->
            <div class="text-center">
                <h1 class="text-lg font-semibold text-olive-950">Checkout</h1>
                <p class="text-xs text-olive-500">Secure checkout</p>
            </div>
            
            <!-- Right: Lock Icon -->
            <div class="p-2 -mr-2">
                <i data-lucide="shield-check" class="w-5 h-5 text-emerald-600"></i>
            </div>
        </div>
        
        <!-- Progress Steps -->
        <div class="px-4 pb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div id="step1-indicator" class="w-8 h-8 rounded-full bg-olive-700 text-white flex items-center justify-center text-sm font-semibold">1</div>
                    <span class="text-sm font-medium text-olive-700 hidden sm:inline">Shipping</span>
                </div>
                <div class="flex-1 h-0.5 bg-olive-200 mx-2">
                    <div id="progress-bar-1" class="h-full bg-olive-700 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="step2-indicator" class="w-8 h-8 rounded-full bg-olive-200 text-olive-500 flex items-center justify-center text-sm font-semibold">2</div>
                    <span class="text-sm text-olive-400 hidden sm:inline">Review</span>
                </div>
                <div class="flex-1 h-0.5 bg-olive-200 mx-2">
                    <div id="progress-bar-2" class="h-full bg-olive-700 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="step3-indicator" class="w-8 h-8 rounded-full bg-olive-200 text-olive-500 flex items-center justify-center text-sm font-semibold">3</div>
                    <span class="text-sm text-olive-400 hidden sm:inline">Payment</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="pb-40">
        
        <!-- Empty Cart State -->
        <div id="empty-checkout" class="hidden text-center py-20 px-4">
            <div class="w-24 h-24 mx-auto bg-olive-100 rounded-full flex items-center justify-center mb-6">
                <i data-lucide="shopping-bag" class="w-12 h-12 text-olive-400"></i>
            </div>
            <h2 class="text-xl font-semibold text-olive-900 mb-2">Your cart is empty</h2>
            <p class="text-olive-500 mb-8 max-w-sm mx-auto">
                Add some items to your cart before checkout.
            </p>
            <a href="/products" class="inline-flex items-center gap-2 px-6 py-3 bg-olive-700 text-white font-medium rounded-xl hover:bg-olive-800 transition-colors">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                Start Shopping
            </a>
        </div>
        
        <!-- Checkout Form Container -->
        <form id="checkout-form" class="hidden" action="/checkout" method="POST">
            
            <!-- ========== STEP 1: SHIPPING ========== -->
            <div id="step-1" class="checkout-step">
                <!-- Contact Information -->
                <div class="bg-white p-4 mb-2">
                    <h2 class="text-lg font-semibold text-olive-900 mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-olive-600"></i>
                        Contact Information
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Name Row -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-olive-700 mb-1">First Name *</label>
                                <input 
                                    type="text" 
                                    id="firstName" 
                                    name="firstName" 
                                    required
                                    autocomplete="given-name"
                                    class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="John"
                                >
                            </div>
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-olive-700 mb-1">Last Name *</label>
                                <input 
                                    type="text" 
                                    id="lastName" 
                                    name="lastName" 
                                    required
                                    autocomplete="family-name"
                                    class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="Doe"
                                >
                            </div>
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-olive-700 mb-1">Email Address *</label>
                            <div class="relative">
                                <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-olive-400"></i>
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    required
                                    autocomplete="email"
                                    class="w-full pl-12 pr-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="john@example.com"
                                >
                            </div>
                            <p class="text-xs text-olive-400 mt-1">Order confirmation will be sent here</p>
                        </div>
                        
                        <!-- Phone -->
                        <div>
                            <label for="phone" class="block text-sm font-medium text-olive-700 mb-1">Phone Number *</label>
                            <div class="relative">
                                <i data-lucide="phone" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-olive-400"></i>
                                <input 
                                    type="tel" 
                                    id="phone" 
                                    name="phone" 
                                    required
                                    autocomplete="tel"
                                    class="w-full pl-12 pr-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="+1 (555) 000-0000"
                                >
                            </div>
                            <p class="text-xs text-olive-400 mt-1">For delivery updates</p>
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Address -->
                <div class="bg-white p-4 mb-2">
                    <h2 class="text-lg font-semibold text-olive-900 mb-4 flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-5 h-5 text-olive-600"></i>
                        Shipping Address
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Street Address -->
                        <div>
                            <label for="street" class="block text-sm font-medium text-olive-700 mb-1">Street Address *</label>
                            <input 
                                type="text" 
                                id="street" 
                                name="street" 
                                required
                                autocomplete="street-address"
                                class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                placeholder="123 Main Street"
                            >
                        </div>
                        
                        <!-- Apt/Suite (Optional) -->
                        <div>
                            <label for="apt" class="block text-sm font-medium text-olive-700 mb-1">Apartment, Suite, etc. <span class="text-olive-400 font-normal">(Optional)</span></label>
                            <input 
                                type="text" 
                                id="apt" 
                                name="apt"
                                autocomplete="address-line2"
                                class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                placeholder="Apt 4B"
                            >
                        </div>
                        
                        <!-- City/State Row -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="city" class="block text-sm font-medium text-olive-700 mb-1">City *</label>
                                <input 
                                    type="text" 
                                    id="city" 
                                    name="city" 
                                    required
                                    autocomplete="address-level2"
                                    class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="New York"
                                >
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium text-olive-700 mb-1">State *</label>
                                <input 
                                    type="text" 
                                    id="state" 
                                    name="state" 
                                    required
                                    autocomplete="address-level1"
                                    class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="NY"
                                >
                            </div>
                        </div>
                        
                        <!-- ZIP/Country Row -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="zipCode" class="block text-sm font-medium text-olive-700 mb-1">ZIP Code *</label>
                                <input 
                                    type="text" 
                                    id="zipCode" 
                                    name="zipCode" 
                                    required
                                    autocomplete="postal-code"
                                    class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                    placeholder="10001"
                                >
                            </div>
                            <div>
                                <label for="country" class="block text-sm font-medium text-olive-700 mb-1">Country *</label>
                                <select 
                                    id="country" 
                                    name="country" 
                                    required
                                    autocomplete="country"
                                    class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 bg-white focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                                >
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="UK">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Options -->
                <div class="bg-white p-4">
                    <h2 class="text-lg font-semibold text-olive-900 mb-4 flex items-center gap-2">
                        <i data-lucide="truck" class="w-5 h-5 text-olive-600"></i>
                        Delivery Options
                    </h2>
                    
                    <div class="space-y-3">
                        <label class="block p-4 border-2 border-olive-200 rounded-xl cursor-pointer hover:border-olive-400 transition-colors has-[:checked]:border-olive-700 has-[:checked]:bg-olive-50">
                            <div class="flex items-start gap-3">
                                <input type="radio" name="shipping" value="standard" checked class="mt-1 w-4 h-4 text-olive-700 focus:ring-olive-500">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-olive-900">Standard Shipping</p>
                                            <p class="text-sm text-olive-500">5-7 business days</p>
                                        </div>
                                        <span id="standard-shipping-cost" class="font-semibold text-olive-900">$5.99</span>
                                    </div>
                                </div>
                            </div>
                        </label>
                        
                        <label class="block p-4 border-2 border-olive-200 rounded-xl cursor-pointer hover:border-olive-400 transition-colors has-[:checked]:border-olive-700 has-[:checked]:bg-olive-50">
                            <div class="flex items-start gap-3">
                                <input type="radio" name="shipping" value="express" class="mt-1 w-4 h-4 text-olive-700 focus:ring-olive-500">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-olive-900">Express Shipping</p>
                                            <p class="text-sm text-olive-500">2-3 business days</p>
                                        </div>
                                        <span class="font-semibold text-olive-900">$12.99</span>
                                    </div>
                                </div>
                            </div>
                        </label>
                        
                        <label class="block p-4 border-2 border-emerald-200 rounded-xl cursor-pointer hover:border-emerald-400 transition-colors has-[:checked]:border-emerald-600 has-[:checked]:bg-emerald-50">
                            <div class="flex items-start gap-3">
                                <input type="radio" name="shipping" value="free" class="mt-1 w-4 h-4 text-emerald-600 focus:ring-emerald-500" id="free-shipping-option" disabled>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-olive-900">Free Shipping</p>
                                            <p class="text-sm text-olive-500">5-7 business days</p>
                                            <p id="free-shipping-note" class="text-xs text-emerald-600 mt-1">Available on orders $100+</p>
                                        </div>
                                        <span class="font-semibold text-emerald-600">FREE</span>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- ========== STEP 2: REVIEW ========== -->
            <div id="step-2" class="checkout-step hidden">
                <!-- Order Items -->
                <div class="bg-white p-4 mb-2">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-olive-900 flex items-center gap-2">
                            <i data-lucide="package" class="w-5 h-5 text-olive-600"></i>
                            Order Items
                        </h2>
                        <a href="/cart" class="text-sm text-olive-600 hover:text-olive-800 flex items-center gap-1">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                            Edit
                        </a>
                    </div>
                    
                    <div id="review-items" class="space-y-4">
                        <!-- Items will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Shipping Summary -->
                <div class="bg-white p-4 mb-2">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-olive-900 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-olive-600"></i>
                            Shipping To
                        </h2>
                        <button type="button" onclick="goToStep(1)" class="text-sm text-olive-600 hover:text-olive-800 flex items-center gap-1">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                            Edit
                        </button>
                    </div>
                    
                    <div id="shipping-summary" class="text-olive-700">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Promo Code -->
                <div class="bg-white p-4">
                    <h2 class="text-lg font-semibold text-olive-900 mb-4 flex items-center gap-2">
                        <i data-lucide="ticket" class="w-5 h-5 text-olive-600"></i>
                        Promo Code
                    </h2>
                    
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                id="promo-code" 
                                name="promoCode"
                                placeholder="Enter promo code"
                                class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                            >
                        </div>
                        <button type="button" id="apply-promo" class="px-5 py-3 bg-olive-100 text-olive-700 font-medium rounded-xl hover:bg-olive-200 transition-colors">
                            Apply
                        </button>
                    </div>
                    <p id="promo-message" class="hidden text-sm mt-2"></p>
                </div>
            </div>
            
            <!-- ========== STEP 3: PAYMENT ========== -->
            <div id="step-3" class="checkout-step hidden">
                <!-- Payment Methods -->
                <div class="bg-white p-4 mb-2">
                    <h2 class="text-lg font-semibold text-olive-900 mb-4 flex items-center gap-2">
                        <i data-lucide="credit-card" class="w-5 h-5 text-olive-600"></i>
                        Payment Method
                    </h2>
                    
                    <div class="space-y-3">
                        <!-- Cash on Delivery -->
                        <label class="block p-4 border-2 border-olive-200 rounded-xl cursor-pointer hover:border-olive-400 transition-colors has-[:checked]:border-olive-700 has-[:checked]:bg-olive-50">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="paymentMethod" value="cod" checked class="w-4 h-4 text-olive-700 focus:ring-olive-500">
                                <div class="flex-1">
                                    <p class="font-medium text-olive-900">Cash on Delivery</p>
                                    <p class="text-sm text-olive-500">Pay when you receive your order</p>
                                </div>
                                <i data-lucide="banknote" class="w-6 h-6 text-olive-400"></i>
                            </div>
                        </label>
                        
                        <!-- WhatsApp Order -->
                        <label class="block p-4 border-2 border-green-200 rounded-xl cursor-pointer hover:border-green-400 transition-colors has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="paymentMethod" value="whatsapp" class="w-4 h-4 text-green-600 focus:ring-green-500">
                                <div class="flex-1">
                                    <p class="font-medium text-olive-900">Order via WhatsApp</p>
                                    <p class="text-sm text-olive-500">Complete your order through WhatsApp</p>
                                </div>
                                <i data-lucide="message-circle" class="w-6 h-6 text-green-500"></i>
                            </div>
                        </label>
                        
                        <!-- Bank Transfer -->
                        <label class="block p-4 border-2 border-olive-200 rounded-xl cursor-pointer hover:border-olive-400 transition-colors has-[:checked]:border-olive-700 has-[:checked]:bg-olive-50">
                            <div class="flex items-center gap-3">
                                <input type="radio" name="paymentMethod" value="bank" class="w-4 h-4 text-olive-700 focus:ring-olive-500">
                                <div class="flex-1">
                                    <p class="font-medium text-olive-900">Bank Transfer</p>
                                    <p class="text-sm text-olive-500">Transfer to our bank account</p>
                                </div>
                                <i data-lucide="building-2" class="w-6 h-6 text-olive-400"></i>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Order Notes -->
                <div class="bg-white p-4 mb-2">
                    <h2 class="text-lg font-semibold text-olive-900 mb-4 flex items-center gap-2">
                        <i data-lucide="message-square" class="w-5 h-5 text-olive-600"></i>
                        Order Notes <span class="text-olive-400 font-normal text-sm">(Optional)</span>
                    </h2>
                    
                    <textarea 
                        id="orderNotes" 
                        name="orderNotes"
                        rows="3"
                        placeholder="Any special instructions for your order..."
                        class="w-full px-4 py-3 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent resize-none"
                    ></textarea>
                </div>
                
                <!-- Trust & Security -->
                <div class="bg-white p-4">
                    <div class="flex items-center gap-3 p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                        <i data-lucide="shield-check" class="w-8 h-8 text-emerald-600 flex-shrink-0"></i>
                        <div>
                            <p class="font-medium text-emerald-800">Secure Checkout</p>
                            <p class="text-sm text-emerald-600">Your information is protected with SSL encryption</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mt-4 text-center">
                        <div>
                            <div class="w-10 h-10 mx-auto mb-2 bg-olive-100 rounded-xl flex items-center justify-center">
                                <i data-lucide="truck" class="w-5 h-5 text-olive-600"></i>
                            </div>
                            <p class="text-xs text-olive-600">Fast Delivery</p>
                        </div>
                        <div>
                            <div class="w-10 h-10 mx-auto mb-2 bg-olive-100 rounded-xl flex items-center justify-center">
                                <i data-lucide="rotate-ccw" class="w-5 h-5 text-olive-600"></i>
                            </div>
                            <p class="text-xs text-olive-600">Easy Returns</p>
                        </div>
                        <div>
                            <div class="w-10 h-10 mx-auto mb-2 bg-olive-100 rounded-xl flex items-center justify-center">
                                <i data-lucide="headphones" class="w-5 h-5 text-olive-600"></i>
                            </div>
                            <p class="text-xs text-olive-600">24/7 Support</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hidden cart data -->
            <input type="hidden" name="cartItems" id="cartItemsInput">
            
        </form>
        
    </main>

    <!-- ========== STICKY BOTTOM ========== -->
    <div id="checkout-footer" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-olive-100 z-40">
        <!-- Order Summary Toggle (Mobile) -->
        <button type="button" id="summary-toggle" class="w-full px-4 py-3 flex items-center justify-between bg-olive-50 border-b border-olive-100">
            <span class="text-sm text-olive-600 flex items-center gap-2">
                <i data-lucide="receipt" class="w-4 h-4"></i>
                Order Summary
            </span>
            <div class="flex items-center gap-2">
                <span id="footer-total" class="font-bold text-olive-900">$0.00</span>
                <i data-lucide="chevron-up" class="w-5 h-5 text-olive-400 summary-chevron transition-transform"></i>
            </div>
        </button>
        
        <!-- Expandable Summary -->
        <div id="summary-details" class="hidden px-4 py-3 bg-white border-b border-olive-100 space-y-2">
            <div class="flex justify-between text-sm">
                <span class="text-olive-500">Subtotal (<span id="summary-item-count">0</span> items)</span>
                <span id="summary-subtotal" class="text-olive-900">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-olive-500">Shipping</span>
                <span id="summary-shipping" class="text-olive-900">$5.99</span>
            </div>
            <div id="summary-discount-row" class="hidden flex justify-between text-sm">
                <span class="text-emerald-600">Discount</span>
                <span id="summary-discount" class="text-emerald-600">-$0.00</span>
            </div>
            <div class="flex justify-between pt-2 border-t border-olive-100">
                <span class="font-semibold text-olive-900">Total</span>
                <span id="summary-total" class="font-bold text-olive-900">$0.00</span>
            </div>
        </div>
        
        <!-- Action Button -->
        <div class="px-4 py-4">
            <!-- Step 1 & 2: Continue Button -->
            <button type="button" id="continue-btn" class="flex items-center justify-center gap-2 w-full py-4 bg-olive-700 hover:bg-olive-800 text-white font-semibold rounded-xl transition-colors shadow-lg shadow-olive-700/25">
                <span>Continue to Review</span>
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
            
            <!-- Step 3: Place Order Button -->
            <button type="submit" id="place-order-btn" form="checkout-form" class="hidden flex items-center justify-center gap-2 w-full py-4 bg-olive-700 hover:bg-olive-800 text-white font-semibold rounded-xl transition-colors shadow-lg shadow-olive-700/25">
                <i data-lucide="lock" class="w-5 h-5"></i>
                <span>Place Order</span>
            </button>
        </div>
    </div>

</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Cart data from localStorage
    let checkoutCart = JSON.parse(localStorage.getItem('cart')) || [];
    
    // Current step
    let currentStep = 1;
    
    // Shipping costs
    const SHIPPING_COSTS = {
        standard: 5.99,
        express: 12.99,
        free: 0
    };
    
    // Free shipping threshold
    const FREE_SHIPPING_THRESHOLD = 100;
    
    // Discount
    let discount = 0;
    
    // DOM Elements
    const emptyCheckout = document.getElementById('empty-checkout');
    const checkoutForm = document.getElementById('checkout-form');
    const checkoutFooter = document.getElementById('checkout-footer');
    const continueBtn = document.getElementById('continue-btn');
    const placeOrderBtn = document.getElementById('place-order-btn');
    const summaryToggle = document.getElementById('summary-toggle');
    const summaryDetails = document.getElementById('summary-details');
    
    // Initialize checkout
    function initCheckout() {
        if (checkoutCart.length === 0) {
            emptyCheckout.classList.remove('hidden');
            checkoutForm.classList.add('hidden');
            checkoutFooter.classList.add('hidden');
        } else {
            emptyCheckout.classList.add('hidden');
            checkoutForm.classList.remove('hidden');
            checkoutFooter.classList.remove('hidden');
            
            updateOrderSummary();
            checkFreeShipping();
            loadSavedData();
        }
    }
    
    // Update order summary
    function updateOrderSummary() {
        const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
        const itemCount = checkoutCart.reduce((sum, item) => sum + item.quantity, 0);
        const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || 'standard';
        const shippingCost = SHIPPING_COSTS[shippingMethod];
        const total = subtotal + shippingCost - discount;
        
        // Update summary elements
        document.getElementById('summary-item-count').textContent = itemCount;
        document.getElementById('summary-subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('summary-shipping').textContent = shippingCost === 0 ? 'FREE' : '$' + shippingCost.toFixed(2);
        document.getElementById('summary-total').textContent = '$' + total.toFixed(2);
        document.getElementById('footer-total').textContent = '$' + total.toFixed(2);
        
        // Discount row
        if (discount > 0) {
            document.getElementById('summary-discount-row').classList.remove('hidden');
            document.getElementById('summary-discount').textContent = '-$' + discount.toFixed(2);
        } else {
            document.getElementById('summary-discount-row').classList.add('hidden');
        }
        
        // Update hidden cart input
        document.getElementById('cartItemsInput').value = JSON.stringify(checkoutCart);
    }
    
    // Check and enable free shipping
    function checkFreeShipping() {
        const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
        const freeShippingOption = document.getElementById('free-shipping-option');
        const freeShippingNote = document.getElementById('free-shipping-note');
        
        if (subtotal >= FREE_SHIPPING_THRESHOLD) {
            freeShippingOption.disabled = false;
            freeShippingOption.checked = true;
            freeShippingNote.textContent = '‚úì You qualify for free shipping!';
            updateOrderSummary();
        } else {
            freeShippingOption.disabled = true;
            const remaining = FREE_SHIPPING_THRESHOLD - subtotal;
            freeShippingNote.textContent = `Add $${remaining.toFixed(2)} more for free shipping`;
        }
    }
    
    // Load saved form data
    function loadSavedData() {
        const savedData = JSON.parse(localStorage.getItem('checkoutData')) || {};
        Object.keys(savedData).forEach(key => {
            const input = document.getElementById(key);
            if (input) {
                input.value = savedData[key];
            }
        });
    }
    
    // Save form data
    function saveFormData() {
        const formData = {};
        const inputs = checkoutForm.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], select, textarea');
        inputs.forEach(input => {
            if (input.id && input.value) {
                formData[input.id] = input.value;
            }
        });
        localStorage.setItem('checkoutData', JSON.stringify(formData));
    }
    
    // Go to step
    function goToStep(step) {
        // Validate current step before moving forward
        if (step > currentStep && !validateStep(currentStep)) {
            return;
        }
        
        // Save form data
        saveFormData();
        
        // Hide all steps
        document.querySelectorAll('.checkout-step').forEach(s => s.classList.add('hidden'));
        
        // Show target step
        document.getElementById('step-' + step).classList.remove('hidden');
        
        // Update progress indicators
        updateProgressIndicators(step);
        
        // Update button text
        updateActionButton(step);
        
        // If going to review step, populate review
        if (step === 2) {
            populateReview();
        }
        
        currentStep = step;
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Validate step
    function validateStep(step) {
        if (step === 1) {
            const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'street', 'city', 'state', 'zipCode'];
            for (const field of requiredFields) {
                const input = document.getElementById(field);
                if (!input.value.trim()) {
                    input.focus();
                    input.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    setTimeout(() => {
                        input.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                    }, 3000);
                    return false;
                }
                input.classList.remove('border-red-500');
            }
        }
        return true;
    }
    
    // Update progress indicators
    function updateProgressIndicators(step) {
        const step1 = document.getElementById('step1-indicator');
        const step2 = document.getElementById('step2-indicator');
        const step3 = document.getElementById('step3-indicator');
        const progress1 = document.getElementById('progress-bar-1');
        const progress2 = document.getElementById('progress-bar-2');
        
        // Reset all
        [step1, step2, step3].forEach(s => {
            s.classList.remove('bg-olive-700', 'text-white', 'bg-emerald-500');
            s.classList.add('bg-olive-200', 'text-olive-500');
        });
        
        if (step >= 1) {
            step1.classList.remove('bg-olive-200', 'text-olive-500');
            step1.classList.add('bg-olive-700', 'text-white');
        }
        if (step >= 2) {
            progress1.style.width = '100%';
            step2.classList.remove('bg-olive-200', 'text-olive-500');
            step2.classList.add('bg-olive-700', 'text-white');
        } else {
            progress1.style.width = '0%';
        }
        if (step >= 3) {
            progress2.style.width = '100%';
            step3.classList.remove('bg-olive-200', 'text-olive-500');
            step3.classList.add('bg-olive-700', 'text-white');
        } else {
            progress2.style.width = '0%';
        }
    }
    
    // Update action button
    function updateActionButton(step) {
        if (step === 3) {
            continueBtn.classList.add('hidden');
            placeOrderBtn.classList.remove('hidden');
        } else {
            continueBtn.classList.remove('hidden');
            placeOrderBtn.classList.add('hidden');
            continueBtn.querySelector('span').textContent = step === 1 ? 'Continue to Review' : 'Continue to Payment';
        }
    }
    
    // Populate review step
    function populateReview() {
        // Items
        const reviewItems = document.getElementById('review-items');
        reviewItems.innerHTML = checkoutCart.map(item => `
            <div class="flex gap-3">
                <div class="w-16 h-16 bg-olive-50 rounded-lg overflow-hidden flex-shrink-0">
                    <img src="${item.image || 'https://placehold.co/100x100/f7f8f3/556B2F?text=No+Image'}" alt="${item.name}" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-medium text-olive-900 line-clamp-1">${item.name}</h3>
                    <p class="text-sm text-olive-500">Qty: ${item.quantity}</p>
                    <p class="text-sm font-semibold text-olive-700">$${(parseFloat(item.price) * item.quantity).toFixed(2)}</p>
                </div>
            </div>
        `).join('');
        
        // Shipping summary
        const shippingSummary = document.getElementById('shipping-summary');
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const street = document.getElementById('street').value;
        const apt = document.getElementById('apt').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const zipCode = document.getElementById('zipCode').value;
        const phone = document.getElementById('phone').value;
        
        shippingSummary.innerHTML = `
            <p class="font-medium text-olive-900">${firstName} ${lastName}</p>
            <p>${street}${apt ? ', ' + apt : ''}</p>
            <p>${city}, ${state} ${zipCode}</p>
            <p class="mt-2 text-sm text-olive-500">${phone}</p>
        `;
        
        lucide.createIcons();
    }
    
    // Toggle summary
    summaryToggle?.addEventListener('click', () => {
        summaryDetails.classList.toggle('hidden');
        const chevron = summaryToggle.querySelector('.summary-chevron');
        chevron.classList.toggle('rotate-180');
    });
    
    // Continue button
    continueBtn?.addEventListener('click', () => {
        goToStep(currentStep + 1);
    });
    
    // Shipping method change
    document.querySelectorAll('input[name="shipping"]').forEach(radio => {
        radio.addEventListener('change', updateOrderSummary);
    });
    
    // Promo code
    document.getElementById('apply-promo')?.addEventListener('click', () => {
        const code = document.getElementById('promo-code').value.trim().toUpperCase();
        const message = document.getElementById('promo-message');
        
        if (code === 'RACKET10') {
            const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
            discount = subtotal * 0.1;
            message.textContent = '‚úì Code applied! 10% off';
            message.classList.remove('hidden', 'text-red-500');
            message.classList.add('text-emerald-600');
            updateOrderSummary();
        } else if (code === '') {
            message.textContent = 'Please enter a promo code';
            message.classList.remove('hidden', 'text-emerald-600');
            message.classList.add('text-red-500');
        } else {
            message.textContent = 'Invalid promo code';
            message.classList.remove('hidden', 'text-emerald-600');
            message.classList.add('text-red-500');
            discount = 0;
            updateOrderSummary();
        }
    });
    
    // Form submission
    checkoutForm?.addEventListener('submit', (e) => {
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
        if (paymentMethod === 'whatsapp') {
            e.preventDefault();
            
            // Build WhatsApp message
            const items = checkoutCart.map(item => `${item.name} x${item.quantity} - $${(parseFloat(item.price) * item.quantity).toFixed(2)}`).join('\n');
            const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
            const total = subtotal - discount;
            
            const message = `üè∏ *New Order from RacketBazaar*\n\n` +
                `*Customer:* ${document.getElementById('firstName').value} ${document.getElementById('lastName').value}\n` +
                `*Phone:* ${document.getElementById('phone').value}\n` +
                `*Address:* ${document.getElementById('street').value}, ${document.getElementById('city').value}, ${document.getElementById('state').value} ${document.getElementById('zipCode').value}\n\n` +
                `*Items:*\n${items}\n\n` +
                `*Total:* $${total.toFixed(2)}`;
            
            window.open(`https://wa.me/1234567890?text=${encodeURIComponent(message)}`, '_blank');
        }
        // Otherwise, normal form submission
    });
    
    // Auto-save on input
    checkoutForm?.addEventListener('input', saveFormData);
    
    // Initialize
    initCheckout();
</script>

<%- include('partials/tail') %>
