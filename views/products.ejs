<%- include('partials/head', { pageClass: 'page-products' }) %>

<!-- ================================ -->
<!-- PRODUCTS LISTING PAGE            -->
<!-- RacketBazaar - Mobile-First      -->
<!-- Redesigned: One Product Per Row  -->
<!-- ================================ -->

<style>
    /* Custom styles for the new product cards */
    .media-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 2px;
        aspect-ratio: 1;
        background: #f7f8f3;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .media-item {
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    
    .media-item img,
    .media-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .media-item:hover img,
    .media-item:hover video {
        transform: scale(1.05);
    }
    
    .media-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .media-overlay span {
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    /* Expanded media view */
    .media-expanded {
        position: relative;
    }
    
    .media-expanded .main-media {
        width: 100%;
        aspect-ratio: 1;
        background: #f7f8f3;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .media-expanded .main-media img,
    .media-expanded .main-media video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .media-expanded .media-thumbnails {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 12px 0;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .media-expanded .media-thumbnails::-webkit-scrollbar {
        display: none;
    }
    
    .media-expanded .media-thumb {
        flex-shrink: 0;
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    
    .media-expanded .media-thumb.active {
        border-color: #556B2F;
    }
    
    .media-expanded .media-thumb img,
    .media-expanded .media-thumb video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Description expand animation */
    .description-text {
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .description-text.collapsed {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        max-height: 3rem;
    }
    
    .description-text.expanded {
        max-height: 500px;
    }
    
    .expand-toggle {
        transition: transform 0.3s ease;
    }
    
    .expand-toggle.rotated {
        transform: rotate(180deg);
    }
    
    /* Video play indicator */
    .video-indicator {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        pointer-events: none;
    }
    
    .video-indicator i {
        color: white;
        width: 32px;
        height: 32px;
    }
</style>

<div class="min-h-screen bg-olive-50 font-sans">

    <!-- ========== STICKY HEADER ========== -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-olive-100">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Left: Hamburger Menu -->
            <button id="menu-toggle" class="p-2 -ml-2 rounded-lg hover:bg-olive-100 active:bg-olive-200 transition-colors" aria-label="Open menu">
                <i data-lucide="menu" class="w-6 h-6 text-olive-950"></i>
            </button>
            
            <!-- Center: Logo -->
            <a href="/" class="flex items-center gap-1">
                <span class="text-xl font-bold text-olive-700 tracking-tight">Racket</span>
                <span class="text-xl font-bold text-olive-950">Bazaar</span>
            </a>
            
            <!-- Right: Icons -->
            <div class="flex items-center gap-1">
                <button id="search-toggle" class="p-2 rounded-lg hover:bg-olive-100 active:bg-olive-200 transition-colors" aria-label="Search">
                    <i data-lucide="search" class="w-5 h-5 text-olive-950"></i>
                </button>
            </div>
        </div>
        
        <!-- Search Bar (Hidden by default) -->
        <div id="search-bar" class="hidden px-4 pb-3">
            <form action="/products" method="GET" class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-olive-400"></i>
                <input 
                    type="text" 
                    name="search"
                    value="<%= search || '' %>"
                    placeholder="Search products..." 
                    class="w-full pl-12 pr-4 py-3 bg-olive-50 border border-olive-200 rounded-xl text-olive-900 placeholder-olive-400 focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent"
                >
            </form>
        </div>
    </header>

    <!-- ========== MOBILE SLIDE-OUT MENU ========== -->
    <div id="mobile-menu" class="fixed inset-0 z-50 pointer-events-none">
        <div id="menu-backdrop" class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300"></div>
        <div id="menu-panel" class="absolute top-0 left-0 h-full w-72 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-out">
            <div class="flex items-center justify-between p-4 border-b border-olive-100">
                <span class="text-lg font-bold text-olive-700">Menu</span>
                <button id="menu-close" class="p-2 -mr-2 rounded-lg hover:bg-olive-100" aria-label="Close menu">
                    <i data-lucide="x" class="w-5 h-5 text-olive-950"></i>
                </button>
            </div>
            <nav class="p-4 space-y-1">
                <a href="/" class="flex items-center gap-3 px-3 py-3 rounded-lg text-olive-600 hover:bg-olive-50">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    Home
                </a>
                <a href="/products" class="flex items-center gap-3 px-3 py-3 rounded-lg bg-olive-50 text-olive-700 font-medium">
                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                    All Products
                </a>
                <a href="/products?category=rackets" class="flex items-center gap-3 px-3 py-3 rounded-lg text-olive-600 hover:bg-olive-50">
                    <i data-lucide="swords" class="w-5 h-5"></i>
                    Rackets
                </a>
                <a href="/products?category=shoes" class="flex items-center gap-3 px-3 py-3 rounded-lg text-olive-600 hover:bg-olive-50">
                    <i data-lucide="footprints" class="w-5 h-5"></i>
                    Shoes
                </a>
                <a href="/stores" class="flex items-center gap-3 px-3 py-3 rounded-lg text-olive-600 hover:bg-olive-50">
                    <i data-lucide="store" class="w-5 h-5"></i>
                    Stores
                </a>
                <div class="pt-4 mt-4 border-t border-olive-100">
                    <a href="/seller/signup" class="flex items-center gap-3 px-3 py-3 rounded-lg text-olive-600 hover:bg-olive-50">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        Become a Seller
                    </a>
                    <a href="/login" class="flex items-center gap-3 px-3 py-3 rounded-lg text-olive-600 hover:bg-olive-50">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        Login
                    </a>
                </div>
            </nav>
        </div>
    </div>

    <!-- ========== BREADCRUMBS ========== -->
    <nav class="px-4 py-3 bg-white border-b border-olive-100">
        <ol class="flex items-center gap-2 text-sm text-olive-500 overflow-x-auto whitespace-nowrap">
            <li><a href="/" class="hover:text-olive-700 transition-colors">Home</a></li>
            <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
            <li><a href="/products" class="hover:text-olive-700 transition-colors">Products</a></li>
            <% if (category) { %>
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li class="text-olive-900 font-medium capitalize"><%= category %></li>
            <% } %>
            <% if (search) { %>
                <li><i data-lucide="chevron-right" class="w-4 h-4"></i></li>
                <li class="text-olive-900 font-medium">Search: "<%= search %>"</li>
            <% } %>
        </ol>
    </nav>

    <!-- ========== CATEGORY PILLS (Horizontal Scroll) ========== -->
    <div class="bg-white border-b border-olive-100 px-4 py-3">
        <div class="flex gap-2 overflow-x-auto scrollbar-hide -mx-4 px-4">
            <a href="/products" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= !category ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                All
            </a>
            <a href="/products?category=rackets" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= category === 'rackets' ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                <i data-lucide="swords" class="w-4 h-4 inline mr-1"></i>Rackets
            </a>
            <a href="/products?category=shoes" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= category === 'shoes' ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                <i data-lucide="footprints" class="w-4 h-4 inline mr-1"></i>Shoes
            </a>
            <a href="/products?category=bags" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= category === 'bags' ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                <i data-lucide="briefcase" class="w-4 h-4 inline mr-1"></i>Bags
            </a>
            <a href="/products?category=apparel" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= category === 'apparel' ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                <i data-lucide="shirt" class="w-4 h-4 inline mr-1"></i>Apparel
            </a>
            <a href="/products?category=shuttles" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= category === 'shuttles' ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                <i data-lucide="circle-dot" class="w-4 h-4 inline mr-1"></i>Shuttles
            </a>
            <a href="/products?category=accessories" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all <%= category === 'accessories' ? 'bg-olive-700 text-white' : 'bg-olive-100 text-olive-700 hover:bg-olive-200' %>">
                <i data-lucide="puzzle" class="w-4 h-4 inline mr-1"></i>Accessories
            </a>
        </div>
    </div>

    <!-- ========== RESULTS BAR ========== -->
    <div class="sticky top-[57px] z-40 bg-olive-50 border-b border-olive-100 px-4 py-3">
        <div class="flex items-center justify-between gap-4">
            <!-- Left: Filter Button & Count -->
            <div class="flex items-center gap-3">
                <button 
                    id="filter-toggle-btn" 
                    class="flex items-center gap-2 px-3 py-2 bg-white border border-olive-200 rounded-xl text-sm font-medium text-olive-700 hover:bg-olive-50 transition-colors"
                >
                    <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                    <span>Filters</span>
                    <% 
                    let activeFilters = 0;
                    if (selectedBrands && selectedBrands.length) activeFilters += selectedBrands.length;
                    if (minPrice || maxPrice) activeFilters++;
                    %>
                    <% if (activeFilters > 0) { %>
                        <span class="w-5 h-5 bg-olive-700 text-white text-xs rounded-full flex items-center justify-center"><%= activeFilters %></span>
                    <% } %>
                </button>
                <p class="text-sm text-olive-600">
                    <span class="font-semibold text-olive-900"><%= totalProducts %></span> product<%= totalProducts !== 1 ? 's' : '' %>
                </p>
            </div>
            
            <!-- Right: Sort -->
            <div class="relative">
                <select 
                    id="sort-select" 
                    onchange="applySortFilter(this.value)"
                    class="appearance-none pl-3 pr-8 py-2 bg-white border border-olive-200 rounded-xl text-sm font-medium text-olive-700 focus:outline-none focus:ring-2 focus:ring-olive-500 cursor-pointer"
                >
                    <option value="" <%= !sort ? 'selected' : '' %>>Newest</option>
                    <option value="price_asc" <%= sort === 'price_asc' ? 'selected' : '' %>>Price: Low → High</option>
                    <option value="price_desc" <%= sort === 'price_desc' ? 'selected' : '' %>>Price: High → Low</option>
                    <option value="name_asc" <%= sort === 'name_asc' ? 'selected' : '' %>>Name: A → Z</option>
                </select>
                <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-olive-400 pointer-events-none"></i>
            </div>
        </div>
        
        <!-- Active Filters Tags -->
        <% if (selectedBrands && selectedBrands.length || minPrice || maxPrice) { %>
            <div class="flex flex-wrap gap-2 mt-3">
                <% if (selectedBrands) { selectedBrands.forEach(brand => { %>
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-olive-200 text-olive-800 text-xs font-medium rounded-full">
                        <%= brand %>
                        <a href="javascript:void(0)" onclick="removeFilter('brand', '<%= brand %>')" class="hover:text-olive-950">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </a>
                    </span>
                <% }) } %>
                <% if (minPrice || maxPrice) { %>
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-olive-200 text-olive-800 text-xs font-medium rounded-full">
                        $<%= minPrice || '0' %> - $<%= maxPrice || '∞' %>
                        <a href="javascript:void(0)" onclick="removePriceFilter()" class="hover:text-olive-950">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </a>
                    </span>
                <% } %>
                <a href="/products<%= category ? '?category=' + category : '' %>" class="text-xs text-olive-600 hover:text-olive-800 underline">
                    Clear all
                </a>
            </div>
        <% } %>
    </div>

    <!-- ========== FILTER DRAWER (Mobile) ========== -->
    <div id="filter-drawer" class="fixed inset-0 z-50 pointer-events-none">
        <div id="filter-backdrop" class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300"></div>
        <div id="filter-panel" class="absolute bottom-0 left-0 right-0 max-h-[85vh] bg-white rounded-t-3xl shadow-xl transform translate-y-full transition-transform duration-300 ease-out overflow-hidden">
            <!-- Handle -->
            <div class="flex justify-center pt-3 pb-2">
                <div class="w-10 h-1 bg-olive-200 rounded-full"></div>
            </div>
            
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-3 border-b border-olive-100">
                <h3 class="text-lg font-semibold text-olive-950">Filters</h3>
                <button id="filter-close" class="p-2 -mr-2 rounded-lg hover:bg-olive-100">
                    <i data-lucide="x" class="w-5 h-5 text-olive-600"></i>
                </button>
            </div>
            
            <!-- Filter Content -->
            <form action="/products" method="GET" id="filter-form" class="overflow-y-auto max-h-[60vh] px-6 py-4">
                <% if (search) { %>
                    <input type="hidden" name="search" value="<%= search %>">
                <% } %>
                <% if (category) { %>
                    <input type="hidden" name="category" value="<%= category %>">
                <% } %>
                
                <!-- Brand Filter -->
                <% if (brands && brands.length > 0) { %>
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-olive-900 mb-3">Brand</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <% brands.forEach(b => { %>
                            <label class="flex items-center gap-2 p-3 bg-olive-50 rounded-xl cursor-pointer hover:bg-olive-100 transition-colors <%= selectedBrands && selectedBrands.includes(b) ? 'ring-2 ring-olive-500 bg-olive-100' : '' %>">
                                <input type="checkbox" name="brand" value="<%= b %>" class="w-4 h-4 text-olive-700 rounded focus:ring-olive-500" <%= selectedBrands && selectedBrands.includes(b) ? 'checked' : '' %>>
                                <span class="text-sm text-olive-700"><%= b %></span>
                            </label>
                        <% }) %>
                    </div>
                </div>
                <% } %>
                
                <!-- Price Range -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-olive-900 mb-3">Price Range</h4>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="text-xs text-olive-500 mb-1 block">Min ($)</label>
                            <input 
                                type="number" 
                                name="minPrice" 
                                placeholder="0" 
                                value="<%= minPrice || '' %>"
                                class="w-full px-3 py-2.5 border border-olive-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-olive-500"
                            >
                        </div>
                        <span class="text-olive-400 mt-5">—</span>
                        <div class="flex-1">
                            <label class="text-xs text-olive-500 mb-1 block">Max ($)</label>
                            <input 
                                type="number" 
                                name="maxPrice" 
                                placeholder="Any" 
                                value="<%= maxPrice || '' %>"
                                class="w-full px-3 py-2.5 border border-olive-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-olive-500"
                            >
                        </div>
                    </div>
                </div>
                
                <!-- Condition -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-olive-900 mb-3">Condition</h4>
                    <div class="flex gap-2">
                        <label class="flex-1 flex items-center justify-center gap-2 p-3 bg-olive-50 rounded-xl cursor-pointer hover:bg-olive-100 transition-colors">
                            <input type="radio" name="condition" value="" class="w-4 h-4 text-olive-700 focus:ring-olive-500" checked>
                            <span class="text-sm text-olive-700">All</span>
                        </label>
                        <label class="flex-1 flex items-center justify-center gap-2 p-3 bg-olive-50 rounded-xl cursor-pointer hover:bg-olive-100 transition-colors">
                            <input type="radio" name="condition" value="new" class="w-4 h-4 text-olive-700 focus:ring-olive-500">
                            <span class="text-sm text-olive-700">New</span>
                        </label>
                        <label class="flex-1 flex items-center justify-center gap-2 p-3 bg-olive-50 rounded-xl cursor-pointer hover:bg-olive-100 transition-colors">
                            <input type="radio" name="condition" value="used" class="w-4 h-4 text-olive-700 focus:ring-olive-500">
                            <span class="text-sm text-olive-700">Pre-owned</span>
                        </label>
                    </div>
                </div>
                
                <!-- Sort -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-olive-900 mb-3">Sort By</h4>
                    <select name="sort" class="w-full px-3 py-2.5 border border-olive-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-olive-500">
                        <option value="" <%= !sort ? 'selected' : '' %>>Newest First</option>
                        <option value="price_asc" <%= sort === 'price_asc' ? 'selected' : '' %>>Price: Low to High</option>
                        <option value="price_desc" <%= sort === 'price_desc' ? 'selected' : '' %>>Price: High to Low</option>
                        <option value="name_asc" <%= sort === 'name_asc' ? 'selected' : '' %>>Name: A to Z</option>
                        <option value="name_desc" <%= sort === 'name_desc' ? 'selected' : '' %>>Name: Z to A</option>
                    </select>
                </div>
            </form>
            
            <!-- Footer Actions -->
            <div class="flex gap-3 px-6 py-4 border-t border-olive-100 bg-white">
                <a href="/products<%= category ? '?category=' + category : '' %>" class="flex-1 py-3 border border-olive-200 text-olive-700 font-medium rounded-xl text-center hover:bg-olive-50 transition-colors">
                    Clear All
                </a>
                <button type="submit" form="filter-form" class="flex-1 py-3 bg-olive-700 text-white font-medium rounded-xl hover:bg-olive-800 transition-colors">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="px-4 py-6">
        <% if (products.length > 0) { %>
            <!-- Product List - One per row -->
            <div class="space-y-6">
                <% products.forEach((product, productIndex) => { 
                    // Combine images and video into media array
                    const allMedia = [];
                    if (product.images && product.images.length > 0) {
                        product.images.forEach(img => {
                            allMedia.push({ type: 'image', url: img });
                        });
                    }
                    if (product.video && product.video.url) {
                        allMedia.push({ type: 'video', url: product.video.url });
                    }
                    const totalMedia = allMedia.length;
                    const displayMedia = allMedia.slice(0, 4);
                    const extraCount = totalMedia > 4 ? totalMedia - 3 : 0;
                %>
                    <article class="product-card bg-white rounded-2xl shadow-sm border border-olive-100 overflow-hidden" data-product-id="<%= product._id %>">
                        
                        <!-- Media Section -->
                        <div class="media-section p-3">
                            <% if (totalMedia === 0) { %>
                                <!-- No media placeholder -->
                                <div class="aspect-square bg-olive-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="image-off" class="w-16 h-16 text-olive-300"></i>
                                </div>
                            <% } else if (totalMedia === 1) { %>
                                <!-- Single media - full width -->
                                <div class="media-expanded" data-product-index="<%= productIndex %>">
                                    <div class="main-media">
                                        <% if (allMedia[0].type === 'video') { %>
                                            <video src="<%= allMedia[0].url %>" controls playsinline class="w-full h-full object-contain"></video>
                                        <% } else { %>
                                            <img src="<%= allMedia[0].url %>" alt="<%= product.name || 'Product' %>" class="w-full h-full object-contain">
                                        <% } %>
                                    </div>
                                </div>
                            <% } else { %>
                                <!-- Grid view for multiple media (collapsed) -->
                                <div class="media-grid-container" data-product-index="<%= productIndex %>">
                                    <!-- Grid View -->
                                    <div class="media-grid grid-view">
                                        <% displayMedia.forEach((media, index) => { 
                                            const isLastAndHasMore = index === 3 && extraCount > 0;
                                        %>
                                            <div class="media-item" data-index="<%= index %>" data-type="<%= media.type %>" data-url="<%= media.url %>">
                                                <% if (media.type === 'video') { %>
                                                    <video src="<%= media.url %>" muted playsinline class="w-full h-full object-cover"></video>
                                                    <div class="video-indicator">
                                                        <i data-lucide="play-circle"></i>
                                                    </div>
                                                <% } else { %>
                                                    <img src="<%= media.url %>" alt="<%= product.name || 'Product' %>" loading="lazy">
                                                <% } %>
                                                <% if (isLastAndHasMore) { %>
                                                    <div class="media-overlay">
                                                        <span>+<%= extraCount %></span>
                                                    </div>
                                                <% } %>
                                            </div>
                                        <% }) %>
                                        <% for (let i = displayMedia.length; i < 4; i++) { %>
                                            <div class="media-item bg-olive-50"></div>
                                        <% } %>
                                    </div>
                                    
                                    <!-- Expanded View (hidden initially) -->
                                    <div class="media-expanded expanded-view hidden">
                                        <div class="main-media">
                                            <% if (allMedia[0].type === 'video') { %>
                                                <video src="<%= allMedia[0].url %>" controls playsinline></video>
                                            <% } else { %>
                                                <img src="<%= allMedia[0].url %>" alt="<%= product.name || 'Product' %>">
                                            <% } %>
                                        </div>
                                        <div class="media-thumbnails">
                                            <% allMedia.forEach((media, idx) => { %>
                                                <div class="media-thumb <%= idx === 0 ? 'active' : '' %>" data-index="<%= idx %>" data-type="<%= media.type %>" data-url="<%= media.url %>">
                                                    <% if (media.type === 'video') { %>
                                                        <video src="<%= media.url %>" muted></video>
                                                    <% } else { %>
                                                        <img src="<%= media.url %>" alt="Thumbnail">
                                                    <% } %>
                                                </div>
                                            <% }) %>
                                        </div>
                                        <button class="collapse-media-btn mt-2 w-full py-2 text-sm text-olive-600 hover:text-olive-800 flex items-center justify-center gap-1">
                                            <i data-lucide="grid-2x2" class="w-4 h-4"></i>
                                            Show grid
                                        </button>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Description Section -->
                        <div class="px-4 pb-4">
                            <!-- Name & Price (if available) -->
                            <% if (product.name || product.price) { %>
                                <div class="flex items-start justify-between mb-2">
                                    <% if (product.name) { %>
                                        <a href="/products/<%= product._id %>" class="font-semibold text-olive-950 hover:text-olive-700">
                                            <%= product.name %>
                                        </a>
                                    <% } %>
                                    <% if (product.price) { %>
                                        <span class="font-bold text-olive-900 ml-2">Rs. <%= product.price.toLocaleString() %></span>
                                    <% } %>
                                </div>
                            <% } %>
                            
                            <!-- Description with expand/collapse -->
                            <% if (product.description) { %>
                                <div class="description-container">
                                    <p class="description-text collapsed text-sm text-olive-600 leading-relaxed">
                                        <%= product.description %>
                                    </p>
                                    <button class="expand-btn flex items-center gap-1 mt-2 text-sm font-medium text-olive-500 hover:text-olive-700">
                                        <span class="expand-text">Show more</span>
                                        <i data-lucide="chevron-down" class="expand-toggle w-4 h-4"></i>
                                    </button>
                                </div>
                            <% } %>

                            <a href="/products/<%= product._id %>" class="flex items-center justify-center gap-2 w-full mt-3 py-3 border border-olive-200 text-olive-700 font-semibold rounded-xl hover:bg-olive-50 transition-colors">
                                <i data-lucide="info" class="w-5 h-5"></i>
                                <span>See full info</span>
                            </a>
                            
                            <!-- WhatsApp Order Button -->
                            <% if (product.sellerInfo && product.sellerInfo.phone) { %>
                                <a 
                                    href="https://wa.me/<%= product.sellerInfo.phone.replace(/[^0-9]/g, '') %>?text=Hi!%20I'm%20interested%20in%20<%= encodeURIComponent(product.name || 'this product') %><%= product.price ? '%20(Rs.%20' + product.price + ')' : '' %>"
                                    target="_blank"
                                    rel="noopener"
                                    class="flex items-center justify-center gap-2 w-full mt-3 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition-colors"
                                >
                                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                                    <span>Order on WhatsApp</span>
                                </a>
                            <% } %>
                        </div>
                    </article>
                <% }) %>
            </div>
            
            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <nav class="mt-8 flex flex-col items-center gap-4">
                    <p class="text-sm text-olive-500">
                        Showing <%= (currentPage - 1) * perPage + 1 %>-<%= Math.min(currentPage * perPage, totalProducts) %> of <%= totalProducts %>
                    </p>
                    
                    <div class="flex items-center gap-2">
                        <% if (currentPage > 1) { %>
                            <a href="<%= buildPaginationUrl(currentPage - 1) %>" class="p-2 bg-white border border-olive-200 rounded-lg hover:bg-olive-50 transition-colors">
                                <i data-lucide="chevron-left" class="w-5 h-5 text-olive-600"></i>
                            </a>
                        <% } %>
                        
                        <% 
                        let startPage = Math.max(1, currentPage - 2);
                        let endPage = Math.min(totalPages, currentPage + 2);
                        
                        if (startPage > 1) { %>
                            <a href="<%= buildPaginationUrl(1) %>" class="w-10 h-10 flex items-center justify-center text-sm font-medium text-olive-600 hover:bg-olive-100 rounded-lg transition-colors">1</a>
                            <% if (startPage > 2) { %>
                                <span class="text-olive-400">...</span>
                            <% } %>
                        <% }
                        
                        for (let i = startPage; i <= endPage; i++) { %>
                            <a href="<%= buildPaginationUrl(i) %>" class="w-10 h-10 flex items-center justify-center text-sm font-medium rounded-lg transition-colors <%= i === currentPage ? 'bg-olive-700 text-white' : 'text-olive-600 hover:bg-olive-100' %>"><%= i %></a>
                        <% }
                        
                        if (endPage < totalPages) { %>
                            <% if (endPage < totalPages - 1) { %>
                                <span class="text-olive-400">...</span>
                            <% } %>
                            <a href="<%= buildPaginationUrl(totalPages) %>" class="w-10 h-10 flex items-center justify-center text-sm font-medium text-olive-600 hover:bg-olive-100 rounded-lg transition-colors"><%= totalPages %></a>
                        <% } %>
                        
                        <% if (currentPage < totalPages) { %>
                            <a href="<%= buildPaginationUrl(currentPage + 1) %>" class="p-2 bg-white border border-olive-200 rounded-lg hover:bg-olive-50 transition-colors">
                                <i data-lucide="chevron-right" class="w-5 h-5 text-olive-600"></i>
                            </a>
                        <% } %>
                    </div>
                </nav>
            <% } %>
            
        <% } else { %>
            <!-- Empty State -->
            <div class="text-center py-16">
                <div class="w-24 h-24 mx-auto bg-olive-100 rounded-full flex items-center justify-center mb-6">
                    <i data-lucide="package-x" class="w-12 h-12 text-olive-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-olive-900 mb-2">No products found</h3>
                <p class="text-olive-500 mb-6 max-w-sm mx-auto">
                    We couldn't find any products matching your criteria. Try adjusting your filters or search terms.
                </p>
                <a href="/products" class="inline-flex items-center gap-2 px-6 py-3 bg-olive-700 text-white font-medium rounded-xl hover:bg-olive-800 transition-colors">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    View All Products
                </a>
            </div>
        <% } %>
    </main>

</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Mobile Menu Toggle
    const menuToggle = document.getElementById('menu-toggle');
    const menuClose = document.getElementById('menu-close');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuBackdrop = document.getElementById('menu-backdrop');
    const menuPanel = document.getElementById('menu-panel');
    
    function openMenu() {
        mobileMenu.classList.remove('pointer-events-none');
        menuBackdrop.classList.remove('opacity-0');
        menuPanel.classList.remove('-translate-x-full');
    }
    
    function closeMenu() {
        mobileMenu.classList.add('pointer-events-none');
        menuBackdrop.classList.add('opacity-0');
        menuPanel.classList.add('-translate-x-full');
    }
    
    menuToggle?.addEventListener('click', openMenu);
    menuClose?.addEventListener('click', closeMenu);
    menuBackdrop?.addEventListener('click', closeMenu);
    
    // Search Toggle
    const searchToggle = document.getElementById('search-toggle');
    const searchBar = document.getElementById('search-bar');
    
    searchToggle?.addEventListener('click', () => {
        searchBar.classList.toggle('hidden');
        if (!searchBar.classList.contains('hidden')) {
            searchBar.querySelector('input').focus();
        }
    });
    
    // Filter Drawer Toggle
    const filterToggleBtn = document.getElementById('filter-toggle-btn');
    const filterClose = document.getElementById('filter-close');
    const filterDrawer = document.getElementById('filter-drawer');
    const filterBackdrop = document.getElementById('filter-backdrop');
    const filterPanel = document.getElementById('filter-panel');
    
    function openFilterDrawer() {
        filterDrawer.classList.remove('pointer-events-none');
        filterBackdrop.classList.remove('opacity-0');
        filterPanel.classList.remove('translate-y-full');
    }
    
    function closeFilterDrawer() {
        filterDrawer.classList.add('pointer-events-none');
        filterBackdrop.classList.add('opacity-0');
        filterPanel.classList.add('translate-y-full');
    }
    
    filterToggleBtn?.addEventListener('click', openFilterDrawer);
    filterClose?.addEventListener('click', closeFilterDrawer);
    filterBackdrop?.addEventListener('click', closeFilterDrawer);
    
    // Sort Filter
    function applySortFilter(sortValue) {
        const url = new URL(window.location.href);
        if (sortValue) {
            url.searchParams.set('sort', sortValue);
        } else {
            url.searchParams.delete('sort');
        }
        window.location.href = url.toString();
    }
    
    // Remove individual filter
    function removeFilter(key, value) {
        const url = new URL(window.location.href);
        const params = url.searchParams.getAll(key);
        url.searchParams.delete(key);
        params.forEach(p => {
            if (p !== value) {
                url.searchParams.append(key, p);
            }
        });
        window.location.href = url.toString();
    }
    
    // Remove price filter
    function removePriceFilter() {
        const url = new URL(window.location.href);
        url.searchParams.delete('minPrice');
        url.searchParams.delete('maxPrice');
        window.location.href = url.toString();
    }
    
    // ========== DESCRIPTION EXPAND/COLLAPSE ==========
    document.querySelectorAll('.expand-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = this.closest('.description-container');
            const text = container.querySelector('.description-text');
            const expandText = this.querySelector('.expand-text');
            const icon = this.querySelector('.expand-toggle');
            
            if (text.classList.contains('collapsed')) {
                text.classList.remove('collapsed');
                text.classList.add('expanded');
                expandText.textContent = 'Show less';
                icon.classList.add('rotated');
            } else {
                text.classList.add('collapsed');
                text.classList.remove('expanded');
                expandText.textContent = 'Show more';
                icon.classList.remove('rotated');
            }
            
            lucide.createIcons();
        });
    });
    
    // ========== MEDIA GRID/EXPANDED VIEW TOGGLE ==========
    document.querySelectorAll('.media-grid-container').forEach(container => {
        const gridView = container.querySelector('.grid-view');
        const expandedView = container.querySelector('.expanded-view');
        const mainMedia = expandedView?.querySelector('.main-media');
        const thumbnails = expandedView?.querySelectorAll('.media-thumb');
        const collapseBtn = expandedView?.querySelector('.collapse-media-btn');
        
        // Click on grid item to expand
        container.querySelectorAll('.grid-view .media-item').forEach(item => {
            item.addEventListener('click', function() {
                const url = this.dataset.url;
                const type = this.dataset.type;
                
                if (!url) return; // Empty cell
                
                // Show expanded view
                gridView.classList.add('hidden');
                expandedView.classList.remove('hidden');
                
                // Update main media
                updateMainMedia(mainMedia, type, url);
                
                // Update active thumbnail
                thumbnails.forEach(thumb => {
                    thumb.classList.remove('active');
                    if (thumb.dataset.url === url) {
                        thumb.classList.add('active');
                    }
                });
                
                lucide.createIcons();
            });
        });
        
        // Click on thumbnail to change main media
        thumbnails?.forEach(thumb => {
            thumb.addEventListener('click', function() {
                const url = this.dataset.url;
                const type = this.dataset.type;
                
                updateMainMedia(mainMedia, type, url);
                
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Collapse back to grid
        collapseBtn?.addEventListener('click', function() {
            expandedView.classList.add('hidden');
            gridView.classList.remove('hidden');
            lucide.createIcons();
        });
    });
    
    function updateMainMedia(container, type, url) {
        if (type === 'video') {
            container.innerHTML = `<video src="${url}" controls playsinline class="w-full h-full object-contain"></video>`;
        } else {
            container.innerHTML = `<img src="${url}" alt="Product image" class="w-full h-full object-contain">`;
        }
    }
</script>

<%- include('partials/tail') %>
